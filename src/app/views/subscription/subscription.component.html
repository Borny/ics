<section class="contact-header">
  <p class="title-xl">
    {{ "Inscriptions" | uppercase }}
  </p>
</section>

<mat-horizontal-stepper linear #stepper labelPosition="bottom">
  <!-- FORMULES -->
  <mat-step [stepControl]="formuleForm" label="Choisissez votre/vos formule(s) ">
    <!-- LOADER -->
    <atom-spinner
      *ngIf="loading"
      [color]="'accent'"
      class="spinner"
    ></atom-spinner>

    <!-- FORM -->
    <form
      [ngClass]="{ hidden: loading }"
      [formGroup]="formuleForm"
      (ngSubmit)="onSubmitFormuleForm()"
    >
      <ng-container formArrayName="formules">
        <!-- KIDS -->
        <atom-label-line [label]="ageGroupEnum.KIDS"></atom-label-line>
        <div class="card__container">
          <molecule-card-formule
            *ngFor="
              let formule of formules$ | async | filter: ageGroupEnum.KIDS
            "
            [formule]="formule"
            [mode]="USER"
            (update)="onUpdateCardFormule($event)"
            (checked)="onToggleChecked($event)"
          ></molecule-card-formule>
        </div>

        <!-- TEENS -->
        <atom-label-line [label]="ageGroupEnum.TEENS"></atom-label-line>
        <div class="card__container">
          <molecule-card-formule
            *ngFor="
              let formule of formules$ | async | filter: ageGroupEnum.TEENS
            "
            [formule]="formule"
            [mode]="USER"
            (checked)="onToggleChecked($event)"
          ></molecule-card-formule>
        </div>

        <!-- ADULTS -->
        <atom-label-line [label]="ageGroupEnum.ADULTS"></atom-label-line>
        <div class="card__container">
          <molecule-card-formule
            *ngFor="
              let formule of formules$ | async | filter: ageGroupEnum.ADULTS
            "
            [formule]="formule"
            [mode]="USER"
            (checked)="onToggleChecked($event)"
          ></molecule-card-formule>
        </div>

        <!-- BTN -->
        <div class="btn__container">
          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="formuleForm.invalid"
            matStepperNext
          >
            Suivant
          </button>
        </div>
      </ng-container>
    </form>
  </mat-step>

  <!-- SUBSCRIPTIONS -->
  <mat-step [stepControl]="subscriptionForm" label="Formulaire d'inscription">
    <ng-template matStepContent>
      <!-- ADULT FORMS -->

      <form
        *ngIf="showSubscriptionForm"
        [formGroup]="subscriptionForm"
        (ngSubmit)="onSubmitSubscriptionForm()"
      >
        <ng-container
          *ngIf="showAdultSubscriptionForm"
          formArrayName="adultsForms"
        >
          <mat-expansion-panel
            *ngFor="
              let subscription of adultsFormsArray.controls;
              let idx = index
            "
            [formGroupName]="idx"
            [expanded]="true"
          >
            <mat-expansion-panel-header>
              <mat-panel-title>
                {{ subscription.get("formule").get("title").value }} -
                {{ subscription.get("formule").get("ageGroup").value }}
              </mat-panel-title>
            </mat-expansion-panel-header>
            <!-- MEMBER INFO -->
            <div class="form-section">
              <p class="form-section__label">Adhérent</p>
              <div class="form-group">
                <mat-form-field>
                  <mat-label>Nom</mat-label>
                  <input
                    matInput
                    type="text"
                    name="memberLastName"
                    formControlName="memberLastName"
                    required
                  />
                  <!-- <mat-error
                    *ngIf="
                      idx.get('memberLastName').invalid &&
                      idx.touched
                    "
                    >Veuillez renseigner le nom</mat-error
                  > -->
                </mat-form-field>
                <mat-form-field>
                  <mat-label>Prénom</mat-label>
                  <input
                    matInput
                    type="text"
                    name="memberFirstName"
                    formControlName="memberFirstName"
                    required
                  />
                  <!-- <mat-error
                    *ngIf="
                      idx.get('memberFirstName').invalid &&
                      idx.touched
                    "
                    >Veuillez renseigner le prénom</mat-error
                  > -->
                </mat-form-field>
                <mat-form-field appearance="fill" class="date-picker">
                  <mat-label>Date de naissance</mat-label>
                  <input
                    matInput
                    [matDatepicker]="picker"
                    formControlName="birthdate"
                    required
                    disabled
                  />
                  <mat-datepicker-toggle matSuffix [for]="picker">
                  </mat-datepicker-toggle>
                  <mat-datepicker #picker disabled="false"></mat-datepicker>
                  <!-- <mat-error
                    *ngIf="
                      idx.get('birthdate').invalid &&
                      idx.touched
                    "
                    >Veuillez renseigner la date de naissance</mat-error
                  > -->
                </mat-form-field>

                <mat-label>Genre</mat-label>
                <mat-radio-group
                  class="radio-group"
                  aria-label="Genre"
                  formControlName="gender"
                >
                  <mat-radio-button
                    *ngFor="let gender of genders; let idx = index"
                    class="radio-button"
                    [value]="idx"
                  >
                    {{ gender }}
                  </mat-radio-button>
                </mat-radio-group>

                <mat-form-field>
                  <mat-label>Téléphone</mat-label>
                  <input
                    matInput
                    type="text"
                    name="phone"
                    formControlName="phone"
                    required
                  />
                  <!-- <mat-error
                    *ngIf="
                      idx.get('phone').invalid &&
                      idx.touched
                    "
                    >Veuillez renseigner votre numéro de téléphone</mat-error
                  > -->
                </mat-form-field>

                <!-- RENEWAL -->
                <mat-checkbox class="form__group" formControlName="renew">
                  Réinscription
                </mat-checkbox>
              </div>
            </div>

            <!-- ACCOUNT CREATION -->
            <div *ngIf="idx === 0" class="form-section">
              <p class="form-section__label">Création du compte</p>

              <div class="form-group">
                <mat-form-field>
                  <mat-label>E-mail</mat-label>
                  <input
                    matInput
                    type="email"
                    name="email"
                    formControlName="email"
                    required
                  />
                  <!-- <mat-error
                    *ngIf="
                      idx.get('email').invalid &&
                      idx.touched
                    "
                    >Veuillez renseigner votre email</mat-error
                  > -->
                </mat-form-field>
                <mat-form-field>
                  <mat-label>Mot de Passe</mat-label>
                  <input
                    matInput
                    type="password"
                    name="password"
                    formControlName="password"
                    required
                  />
                  <!-- <mat-error
                    *ngIf="
                      idx.get('password').invalid &&
                      idx.touched
                    "
                    >Veuillez renseigner un mot de passe</mat-error
                  > -->
                </mat-form-field>
              </div>
            </div>

            <!-- EXTRA INFO -->
            <div class="form-section">
              <p class="form-section__label">Informations supplémentaires</p>
              <div class="form-group">
                <mat-form-field>
                  <mat-label>Détails</mat-label>
                  <textarea
                    matInput
                    name="extraInfo"
                    formControlName="extraInfo"
                  ></textarea>
                </mat-form-field>
              </div>
            </div>

            <div class="form-section">
          <p class="form-section__subscription-amount">
            Montant de l'inscription : <span>{{ subscription.get('formule').get('price').value }}€</span>
          </p>
        </div>

            <!-- <atom-button
          class="btn"
          [type]="'submit'"
          [text]="'Envoyer'"
          [isDisabled]="idx.invalid"
        >
        </atom-button> -->
          </mat-expansion-panel>
        </ng-container>

        <!-- KIDS FORMS -->

        <ng-container *ngIf="showKidSubscriptionForm" formArrayName="kidsForms">
          <mat-expansion-panel
            *ngFor="
              let subscription of kidsFormsArray.controls;
              let idx = index
            "
            [formGroupName]="idx"
            [expanded]="true"
          >
            <mat-expansion-panel-header>
              <mat-panel-title>
                {{ subscription.get("formule").get("title").value }} -
                {{ subscription.get("formule").get("ageGroup").value }}
              </mat-panel-title>
            </mat-expansion-panel-header>

            <!-- MEMBER INFO -->
            <div class="form-section">
              <p class="form-section__label">Adhérent</p>
              <div class="form-group">
                <mat-form-field>
                  <mat-label>Nom</mat-label>
                  <input
                    matInput
                    type="text"
                    name="memberLastName"
                    formControlName="memberLastName"
                    required
                  />
                  <!-- <mat-error
                    *ngIf="
                      idx.get('memberLastName').invalid &&
                      idx.touched
                    "
                    >Veuillez renseigner le nom</mat-error
                  > -->
                </mat-form-field>
                <mat-form-field>
                  <mat-label>Prénom</mat-label>
                  <input
                    matInput
                    type="text"
                    name="memberFirstName"
                    formControlName="memberFirstName"
                    required
                  />
                  <!-- <mat-error
                    *ngIf="
                      idx.get('memberFirstName').invalid &&
                      idx.touched
                    "
                    >Veuillez renseigner le prénom</mat-error
                  > -->
                </mat-form-field>
                <mat-form-field appearance="fill" class="date-picker">
                  <mat-label>Date de naissance</mat-label>
                  <input
                    matInput
                    [matDatepicker]="picker"
                    formControlName="birthdate"
                    required
                    disabled
                  />
                  <mat-datepicker-toggle matSuffix [for]="picker">
                  </mat-datepicker-toggle>
                  <mat-datepicker #picker disabled="false"></mat-datepicker>
                  <!-- <mat-error
                    *ngIf="
                      idx.get('birthdate').invalid &&
                      idx.touched
                    "
                    >Veuillez renseigner la date de naissance</mat-error
                  > -->
                </mat-form-field>

                <mat-label>Genre</mat-label>
                <mat-radio-group
                  class="radio-group"
                  aria-label="Genre"
                  formControlName="gender"
                >
                  <mat-radio-button
                    *ngFor="let gender of genders; let idx = index"
                    class="radio-button"
                    [value]="idx"
                  >
                    {{ gender }}
                  </mat-radio-button>
                </mat-radio-group>

                <!-- RENEWAL -->
                <mat-checkbox class="form__group" formControlName="renew">
                  Réinscription
                </mat-checkbox>

                <!-- <mat-form-field>
                  <mat-label>Téléphone</mat-label>
                  <input
                    matInput
                    type="text"
                    name="phone"
                    formControlName="phone"
                    required
                  />
                  <mat-error
                    *ngIf="
                      idx.get('phone').invalid &&
                      idx.touched
                    "
                    >Veuillez renseigner votre numéro de téléphone</mat-error
                  >
                </mat-form-field> -->
              </div>
            </div>

            <!-- ACCOUNT CREATION -->
            <!-- <div class="form-section">
              <p class="form-section__label">Création du compte</p>

              <div class="form-group">
                <mat-form-field>
                  <mat-label>E-mail</mat-label>
                  <input
                    matInput
                    type="email"
                    name="email"
                    formControlName="email"
                    required
                  />
                  <mat-error
                    *ngIf="
                      idx.get('email').invalid &&
                      idx.touched
                    "
                    >Veuillez renseigner votre email</mat-error
                  >
                </mat-form-field>
                <mat-form-field>
                  <mat-label>Mot de Passe</mat-label>
                  <input
                    matInput
                    type="password"
                    name="password"
                    formControlName="password"
                    required
                  />
                  <mat-error
                    *ngIf="
                      idx.get('password').invalid &&
                      idx.touched
                    "
                    >Veuillez renseigner un mot de passe</mat-error
                  >
                </mat-form-field>
              </div>
            </div> -->

            <!-- EXTRA INFO -->
            <div class="form-section">
              <p class="form-section__label">Informations supplémentaires</p>
              <div class="form-group">
                <mat-form-field>
                  <mat-label>Détails</mat-label>
                  <textarea
                    matInput
                    name="extraInfo"
                    formControlName="extraInfo"
                  ></textarea>
                </mat-form-field>
              </div>
            </div>
          </mat-expansion-panel>
        </ng-container>
      </form>
      <div class="price__container">
        <p class="price__label">Montant total des insciptions:</p>
        <p class="price__amount">{{ totalPrice }}€</p>
      </div>

      <!-- BTNS -->
      <div class="btn__container">
        <button
          type="button"
          mat-raised-button
          color="primary"
          matStepperPrevious
          (click)="onPreviousFormules()"
        >
          Retour
        </button>
        <button
          mat-raised-button
          type="submit"
          color="primary"
          matStepperNext
          [disabled]="subscriptionForm.invalid"
        >
          Suivant
        </button>
      </div>
    </ng-template>
  </mat-step>

  <!-- PAYMENT -->
  <mat-step [stepControl]="paymentForm" label="Paiement">
    <div class="btn__container">
      <button mat-raised-button matStepperPrevious>Retour</button>
      <button mat-raised-button (click)="stepper.reset()">Annuler</button>
    </div>
  </mat-step>
</mat-horizontal-stepper>
